user root;

worker_processes 4;

pid {{ app_data }}/log/nginx.pid;
error_log {{ app_data }}/log/nginx_error.log warn;

events {
    worker_connections 1024;
}

http {
    access_log {{ app_data }}/log/nginx_access.log;

    client_body_temp_path {{ app_data }}/nginx/client_body_temp;
    proxy_temp_path {{ app_data }}/nginx/proxy_temp;
    fastcgi_temp_path {{ app_data }}/nginx/fastcgi_temp;
    uwsgi_temp_path {{ app_data }}/nginx/uwsgi_temp;
    scgi_temp_path {{ app_data }}/nginx/scgi_temp;

    include {{ app_dir }}/nginx/conf/mime.types;
    
    client_max_body_size 10G;

    uwsgi_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;

    #less slow sd card io
    proxy_buffering off;

  server {

    listen 80;
    listen [::]:80;
    listen 443 ssl;
    listen [::]:443 ssl;
    
    server_name {{ '{{' }} user_domain {{ '}}' }};
    
    ssl_certificate     {{ app_data }}/syncloud.crt;
    ssl_certificate_key {{ app_data }}/syncloud.key;
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    root {{ app_dir }}/www/public;

    #add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";

    location /js {
        alias {{ app_dir }}/www/public/js;
    }

    location /images {
        alias {{ app_dir }}/www/public/images;
    }

    location /css {
        alias {{ app_dir }}/www/public/css;
    }

    location / {
        index index.html;
        include {{ config_root }}/config/uwsgi/uwsgi_params;
        uwsgi_pass unix://{{ config_root }}/config/uwsgi/socket/public.wsgi.sock;
    }

    location /appsimages {
        alias {{ apps_root }}/images;
    }

    location /ping {
        return 200 "OK";
    }

  }

    include {{ app_data }}/webapps/*.server;
    include {{ config_root }}/config/nginx/default.app.server;
}