---
layout: public
title: App

show_main_menu: true
main_menu_item: menu_apps
---

<div class="container">
    <div id="app" class="form-horizontal"></div>
</div>

<!-- Create your template -->
<script type="text/html" id='app-template'>
    <div class="col-6 col-md-6 col-sm-6 col-xs-6 col-lg-6">
      <div><img class="center-block" src="appsimages/<%= info.app.id %>-128.png"/></div>
      <div><p class="text-center"><%= info.app.name %></p></div>
    </div>
    <div class="col-6 col-md-6 col-sm-6 col-xs-6 col-lg-6">
        <% _.each(actions, function(el) { %>
            <button id="btn<%= el %>" name="btn<%= el %>"
                    class="btn btn-primary center-block"
                    style="width: 100%; margin-bottom: 10px;">
                <%= el %>
            </button>
        <% }); %>
        <% if (info.installed_version) { %>
            <p class="text-nowrap text-center" style="width: 100%">
                v<%= info.installed_version %>
            </p>
        <% } %>
    </div>
    <div class="col-12 col-md-12 col-sm-12 col-lg-12 col-xs-12">
        <div id="progress-bar" class="progress" style="height: 10px; margin-bottom: 5px; visibility: hidden">
            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0"
                 aria-valuemax="100" style="width: 100%">
                <span class="sr-only">45% Complete</span>
            </div>
        </div>
    </div>
    <div id="errors_placeholder" class="col-12 col-md-12 col-sm-12 col-lg-12 col-xs-12"></div>
</script>

<script type="text/html" id="error_template">
    <div class="alert alert-danger">
        Server error: <%= message %>
    </div>
</script>

<script type="text/javascript" src="js/sam.js"></script>
<script type="text/javascript">

    function get_actions(info) {
        actions = [];
        if (info.installed_version) {
            actions.push('open');
            if (info.current_version != info.installed_version) {
                actions.push('upgrade');
            }
            actions.push('remove');
        } else {
            actions.push('install');
        }
        actions.push('check');

        return actions;
    }

    function progress_start() {
        $('#progress-bar').css('visibility', 'visible');
    }

    function progress_stop() {
        $('#progress-bar').css('visibility', 'hidden');
    }

    function refresh(app_id) {
        $.get( '/rest/app', {app_id: app_id})
                .done( function(data) {
                    var template = $("#app-template").html();
                    data.actions = get_actions(data.info);
                    $("#app").html(_.template(template)(data));
                    register_events(app_id);
                    register_url(data.info.app.url, 'open');
                }).fail( onError );

    }

    function app_status(app_id) {
        refresh(app_id);
        progress_stop();
    }

    function run(action, app_id) {
        $('#errors_placeholder').empty();
        progress_start();
        $.get("/rest/" + action, {app_id: app_id})
                .fail(function(xhr, textStatus, errorThrown) {
                    var template = $("#error_template").html();
                    $('#errors_placeholder').html(_.template(template)(xhr.responseJSON));
                })
                .done(function() {
                    run_after_sam_is_complete(function() {app_status(app_id)});
                });
    }

    function register_events(app_id) {
        register_event(app_id, 'install');
        register_event(app_id, 'remove');
        register_event(app_id, 'upgrade');
        register_event(app_id, 'check');
    }

    function register_event(app_id, action) {
        var btn = $("#btn" + action);
        btn.click(function (event) {
            btn.addClass('disabled');
            event.preventDefault();
            run(action, app_id);
        });
    }

    function register_url(url, action) {
        var btn = $("#btn" + action);
        btn.click(function (event) {
            event.preventDefault();
            window.location.href = url
        });
    }

    $(document).ready(function () {
        refresh(new URI().query(true)['app_id']);
    });

</script>
