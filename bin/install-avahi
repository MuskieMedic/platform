#!/bin/bash

AVAHI_CONFIG=/etc/avahi/services/syncloud.service

apt-get -y install avahi-daemon

if grep -q inet /etc/group; then
    # add user avahi to inet group
    usermod -a -G inet avahi
fi

cat <<AVAHI > ${AVAHI_CONFIG}
<?xml version="1.0" standalone='no'?>
<!DOCTYPE service-group SYSTEM "avahi-service.dtd">
<service-group>
  <name replace-wildcards="yes">syncloud on %h</name>
  <service>
    <type>_ssh._tcp</type>
    <port>22</port>
  </service>
</service-group>
AVAHI

chmod 644 ${AVAHI_CONFIG}

sed 's/AVAHI_DAEMON_DETECT_LOCAL=.*/AVAHI_DAEMON_DETECT_LOCAL=0/g' -i /etc/default/avahi-daemon

service avahi-daemon restart
