import os
from subprocess import check_output
from os.path import isdir
from syncloud_app import logger
import massedit
from syncloud_platform.config.config import PlatformConfig
from syncloud_platform.server.auth import Auth
from syncloud_platform.systemd.systemctl import add_service
from syncloud_platform.tools import app
from syncloud_platform.tools.chown import chown
from syncloud_platform.tools.hardware import relink_disk

log = logger.get_logger('platform.post.install')


def fix_locale_gen(lang, locale_gen='/etc/locale.gen'):
    editor = massedit.MassEdit()
    editor.append_code_expr("re.sub('# {0}', '{0}', line)".format(lang))
    editor.edit_file(locale_gen)

if 'LANG' in os.environ:
    lang = os.environ['LANG']
    if lang not in check_output(['locale', '-a']):
        print("generating locale: {0}".format(lang))
        fix_locale_gen(lang)
        check_output('locale-gen')

platform_config = PlatformConfig()

if not isdir(platform_config.get_disk_root()):
    os.mkdir(platform_config.get_disk_root())

if not isdir(platform_config.get_internal_disk_dir()):
    os.mkdir(platform_config.get_internal_disk_dir())

relink_disk(
    platform_config.get_disk_link(),
    platform_config.get_internal_disk_dir())

log.info(chown('platform', '/opt/app/platform'))

data_dir = app.get_app_data_root('platform', 'platform')
app.create_data_dir(data_dir, 'webapps', 'platform')
app.create_data_dir(data_dir, 'log', 'platform')
app.create_data_dir(data_dir, 'openldap-data', 'platform')

add_service('platform', 'platform-cpu-frequency')
add_service('platform', 'platform-insider-sync')
# add_service('platform', 'platform-resize-sd', start=False)
# add_service('platform', 'platform-udisks-glue')
add_service('platform', 'platform-ntpdate')
add_service('platform', 'platform-uwsgi-internal')
add_service('platform', 'platform-uwsgi-public')
add_service('platform', 'platform-nginx')
add_service('platform', 'platform-openldap', start=Auth().installed())
