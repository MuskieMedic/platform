import os
from subprocess import check_output
from os.path import isdir
from syncloud_app import logger
from syncloud_platform.config.config import PlatformConfig
from syncloud_platform.server.auth import Auth
from syncloud_platform.systemd.systemctl import add_service
from syncloud_platform.tools import app
from syncloud_platform.tools.chown import chown
from syncloud_platform.tools.hardware import Hardware
from syncloud_platform.tools.locale import fix_locale

log = logger.get_logger('platform.post.install')


fix_locale()

platform_config = PlatformConfig()
hardware = Hardware()

if not isdir(platform_config.get_disk_root()):
    os.mkdir(platform_config.get_disk_root())

if not isdir(platform_config.get_internal_disk_dir()):
    os.mkdir(platform_config.get_internal_disk_dir())

if not hardware.external_disk_is_mounted():
    hardware.relink_disk(
        platform_config.get_disk_link(),
        platform_config.get_internal_disk_dir())

log.info(chown('platform', '/opt/app/platform'))

data_dir = app.get_app_data_root('platform', 'platform')
app.create_data_dir(data_dir, 'webapps', 'platform')
app.create_data_dir(data_dir, 'log', 'platform')
app.create_data_dir(data_dir, 'openldap-data', 'platform')

if not os.path.isfile(platform_config.get_ssl_certificate_file()):
    check_output('openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout {0} -out {1} -subj {2} 2>&1'.format(
        platform_config.get_ssl_key_file(),
        platform_config.get_ssl_certificate_file(),
        '/C=US/ST=Syncloud/L=Syncloud/O=Syncloud/OU=Syncloud/CN=localhost'
    ), shell=True)

add_service('platform', 'platform-cpu-frequency')
add_service('platform', 'platform-insider-sync')
add_service('platform', 'platform-ntpdate')
add_service('platform', 'platform-uwsgi-internal')
add_service('platform', 'platform-uwsgi-public')
add_service('platform', 'platform-nginx')
add_service('platform', 'platform-openldap', start=Auth().installed())

