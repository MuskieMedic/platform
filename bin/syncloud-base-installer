#!/bin/bash

HOST=$(cat /etc/hostname)

# update packages
apt-get -y update
apt-get -yf install

# indentifying OS name and version
apt-get -y install lsb-release less
OS_VERSION=$(lsb_release -sr)
OS_ID=$(lsb_release -si)

# disable pi interractive config
if [ -e /etc/profile.d/raspi-config.sh ]; then
    rm -f /etc/profile.d/raspi-config.sh
    sed -i /etc/inittab \
        -e "s/^#\(.*\)#\s*RPICFG_TO_ENABLE\s*/\1/" \
        -e "/#\s*RPICFG_TO_DISABLE/d"
    telinit q
fi

apt-get -y install python
apt-get -y install python-dev

# changing root password, so finish setup could be done through ssh under root
echo "root:syncloud" | chpasswd

#All boards should allow root ssh login for initial setup
sed -i "s/^PermitRootLogin .*/PermitRootLogin yes/g" /etc/ssh/sshd_config

#Disable wifi if any
sed -i '/wlan/d' /etc/network/interfaces

#disable ntpdate, as we have our ntpd service running
rm -rf /etc/network/if-up.d/ntpdate

# change ssh port to 22 for all cubieboards
if [[ ${HOST} = "Cubian" ]]; then
    sed -i "s/Port 36000/Port 22/g" /etc/ssh/sshd_config
    update-rc.d cubian-motd disable
    rm -rf /etc/network/if-up.d/show-morsecode-ip
    #ssh keys and resize we do ourselves
    update-rc.d cubian-firstrun disable
    #disable wifi driver
    echo "blacklist bcmdhd" > /etc/modprobe.d/fbdev-blacklist.conf
fi

# https://github.com/syncloud/image/issues/39
if dpkg -l | grep python-requests; then
    apt-get -y remove python-requests
fi

# delete unnecessary files
if [[ ${HOST} == "raspberrypi" ]]; then

  rm -rf python_games
  apt-get purge -y x11-common midori lxde python3 python3-minimal
  apt-get purge -y lxde-common lxde-icon-theme omxplayer
  apt-get purge -y wolfram-engine

  apt-get autoremove --purge -y
  apt-get update -y

  #Do not upgrade for now as lsb_release -si starts returning non "Debian" value
  #which brakes pi owncloud installation, need to check
  #apt-get upgrade -y

  rm -Rf /etc/X11
  rm -Rf /etc/wpa_supplicant
  rm -Rf /usr/share/icons
  rm -Rf /home/pi/Desktop
  rm -f /home/pi/ocr_pi.png
fi

# delete unnecessary files
if [[ ${HOST} == "odroid" ]]; then
    apt-get purge -y apt-xapian-index lightdm chromium-browser firefox* oracle-java8-installer thunderbird lubuntu-* \
    xscreensaver* openjdk* gnome-* xfce4-* lxde-* openbox xbmc arduino*

    apt-get autoremove --purge -y
fi
rm -rf /var/cache/apt/archives/*.deb
rm -rf /opt/Wolfram
